<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>DAX: ROUND Functions</title>
<link rel="stylesheet" href="../../assets/style.css">
<style>
  /* Styles for Decimal highlighting */
  .decimal-part {
    color: var(--text-dim);
    transition: color 0.3s;
  }
  .decimal-active {
    color: var(--accent);
    font-weight: bold;
    text-decoration: underline;
  }
  .cut-anim {
    animation: cutOff 0.5s forwards;
    color: #ef4444;
    text-decoration: line-through;
  }
  @keyframes cutOff {
    to { opacity: 0.3; transform: scale(0.8); }
  }
</style>
</head>
<body>

<header></header>

<div class="pageWrapper">

  <section class="card">
    <div class="lesson-header">
      <h2>üìè Precision Control</h2>
      <div id="controls-mount" class="settings-row"></div>
    </div>

    <p style="font-size:0.9rem; color:var(--text-dim); margin-bottom: 1rem;">
      <strong>Goal:</strong> Remove decimals to get whole numbers.<br>
      Watch how <strong>.5</strong> and <strong>.1</strong> are handled differently.
    </p>

    <div id="dataTable"></div>

    <div class="calculation-box" id="calcBox">
      Ready...
    </div>
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    
    <div class="control-panel">
      <div class="action-btns">
        <button class="action" id="btnRound">Standard ROUND</button>
        <button class="action primary" id="btnUp">‚¨ÜÔ∏è ROUNDUP</button>
        <button class="action" id="btnDown">‚¨áÔ∏è ROUNDDOWN</button>
      </div>
      <button class="action" id="btnReset" style="margin-top:0.5rem; width:100%;">üîÑ Reset</button>
    </div>
  </section>

  <section class="card">
    <h2>üíª DAX Formula</h2>
    
    <div id="codeDisplay" class="codeArea">
      <div class="codeLine" id="line1"><span class="cmt">-- Scenario 1: Standard Math Rounding</span></div>
      <div class="codeLine" id="line2"><span class="kwd">COLUMN</span> Val = <span class="fn">ROUND</span>( Number, <span class="val">0</span> )</div>
      <div class="codeLine" id="line3"><span class="cmt">-- >= .5 goes Up, < .5 goes Down</span></div>
      <br>
      <div class="codeLine" id="line4"><span class="cmt">-- Scenario 2: Always Ceiling</span></div>
      <div class="codeLine" id="line5"><span class="kwd">COLUMN</span> Val = <span class="fn">ROUNDUP</span>( Number, <span class="val">0</span> )</div>
      <br>
      <div class="codeLine" id="line6"><span class="cmt">-- Scenario 3: Always Floor (Truncate)</span></div>
      <div class="codeLine" id="line7"><span class="kwd">COLUMN</span> Val = <span class="fn">ROUNDDOWN</span>( Number, <span class="val">0</span> )</div>
    </div>

    <div style="margin-top:auto; padding-top:1rem; border-top:1px solid var(--border); display:flex; align-items:center;">
      <span style="color:var(--text-dim); font-size:0.9rem;">Rounded Value:</span>
      <div class="total-bubble" id="totalBubble">-</div>
    </div>
  </section>

</div>

<footer></footer>

<script src="../../assets/app.js"></script>

<script>
  // --- LESSON LOGIC ---
  App.initLayout("ROUND / UP / DOWN", "../../");

  const data = [
    { val: 10.2 }, // Low decimal
    { val: 10.5 }, // Mid decimal (Pivot point)
    { val: 10.9 }  // High decimal
  ];

  const table = document.getElementById('dataTable');
  const totalBubble = document.getElementById('totalBubble');
  const lines = document.querySelectorAll('.codeLine');
  const progressFill = document.getElementById('progressFill');

  let isRunning = false;
  let shouldStop = false;

  function initTable() {
    table.innerHTML = `
      <div class="table-row header">
        <div>Original</div> <div>Decimal</div> <div>Result</div>
      </div>
    `;
    data.forEach((d, i) => {
      const parts = d.val.toString().split('.');
      const whole = parts[0];
      const dec = parts[1];
      
      table.innerHTML += `
        <div class="table-row" id="row-${i}" style="grid-template-columns: 1fr 1fr 1fr;">
          <div>${whole}<span class="decimal-part" id="dec-${i}">.${dec}</span></div>
          <div style="font-size:0.8rem; color:var(--text-dim)" id="desc-${i}">-</div>
          <div class="cell-num" id="res-${i}" style="font-weight:bold;">-</div>
        </div>
      `;
    });
  }

  function reset() {
    shouldStop = true;
    window.speechSynthesis.cancel();
    if(progressFill) { progressFill.style.transition = 'none'; progressFill.style.width = '0%'; }
    
    setTimeout(() => {
      shouldStop = false; isRunning = false;
      initTable();
      App.updateText("Ready...");
      totalBubble.classList.remove('show');
      lines.forEach(l => l.classList.remove('active'));
    }, 100);
  }

  function highlight(id) {
    lines.forEach(l => l.classList.remove('active'));
    if(id) document.getElementById(id).classList.add('active');
  }

  // --- SCENARIO 1: STANDARD ROUND ---
  document.getElementById('btnRound').addEventListener('click', async () => {
    if(isRunning) return;
    reset();
    await new Promise(r => setTimeout(r, 200));
    if(shouldStop) return;

    isRunning = true;
    highlight('line2');
    await App.speak("Starting ROUND. I follow standard math rules. point 5 or higher goes UP.");

    for (let i = 0; i < data.length; i++) {
      if(shouldStop) return;
      const row = document.getElementById(`row-${i}`);
      const decEl = document.getElementById(`dec-${i}`);
      const descEl = document.getElementById(`desc-${i}`);
      const resEl = document.getElementById(`res-${i}`);
      
      row.classList.add('row-highlight');
      decEl.classList.add('decimal-active');

      const val = data[i].val;
      const decimalPart = val - Math.floor(val);
      
      App.updateText(`Checking decimal: ${decimalPart.toFixed(1)}`);
      await new Promise(r => setTimeout(r, 500));

      let result;
      if (decimalPart >= 0.5) {
        result = Math.ceil(val);
        descEl.textContent = ">= 0.5 (Up)";
        descEl.style.color = "#4ade80";
        await App.speak(`Decimal is point 5 or more. Rounding UP.`);
      } else {
        result = Math.floor(val);
        descEl.textContent = "< 0.5 (Down)";
        descEl.style.color = "#facc15";
        await App.speak(`Decimal is less than point 5. Keeping it same.`);
      }
      
      resEl.textContent = result;
      totalBubble.textContent = result;
      totalBubble.classList.add('show');

      if(shouldStop) return;
      await new Promise(r => setTimeout(r, 500));
      
      row.classList.remove('row-highlight');
      decEl.classList.remove('decimal-active');
      totalBubble.classList.remove('show');
    }

    App.updateText("Done.");
    highlight(null);
    isRunning = false;
  });

  // --- SCENARIO 2: ROUNDUP ---
  document.getElementById('btnUp').addEventListener('click', async () => {
    if(isRunning) return;
    reset();
    await new Promise(r => setTimeout(r, 200));
    if(shouldStop) return;

    isRunning = true;
    highlight('line5');
    await App.speak("Starting ROUND-UP. I always push the number higher, away from zero.");

    for (let i = 0; i < data.length; i++) {
      if(shouldStop) return;
      const row = document.getElementById(`row-${i}`);
      const resEl = document.getElementById(`res-${i}`);
      row.classList.add('row-highlight');

      const result = Math.ceil(data[i].val);
      
      App.updateText(`Input: ${data[i].val}. Pushing Up.`);
      await App.speak(`Pushing ${data[i].val} up to ${result}.`);
      
      resEl.textContent = result;
      resCell = resEl;
      resEl.style.color = "#4ade80";
      
      totalBubble.textContent = result;
      totalBubble.classList.add('show');

      if(shouldStop) return;
      await new Promise(r => setTimeout(r, 500));
      row.classList.remove('row-highlight');
      totalBubble.classList.remove('show');
    }

    App.updateText("Done.");
    highlight(null);
    isRunning = false;
  });

  // --- SCENARIO 3: ROUNDDOWN ---
  document.getElementById('btnDown').addEventListener('click', async () => {
    if(isRunning) return;
    reset();
    await new Promise(r => setTimeout(r, 200));
    if(shouldStop) return;

    isRunning = true;
    highlight('line7');
    await App.speak("Starting ROUND-DOWN. I behave like TRUNC. I just cut off the decimal.");

    for (let i = 0; i < data.length; i++) {
      if(shouldStop) return;
      const row = document.getElementById(`row-${i}`);
      const decEl = document.getElementById(`dec-${i}`);
      const resEl = document.getElementById(`res-${i}`);
      row.classList.add('row-highlight');

      // Animation: Cut off decimal
      decEl.classList.add('cut-anim');
      App.updateText(`Chopping off decimal part...`);
      await App.speak(`Removing decimal.`);
      
      const result = Math.floor(data[i].val);
      resEl.textContent = result;
      resEl.style.color = "#ef4444"; // Red/Orange to signify cut

      totalBubble.textContent = result;
      totalBubble.classList.add('show');

      if(shouldStop) return;
      await new Promise(r => setTimeout(r, 500));
      row.classList.remove('row-highlight');
      totalBubble.classList.remove('show');
    }

    App.updateText("Done.");
    highlight(null);
    isRunning = false;
  });

  document.getElementById('btnReset').addEventListener('click', reset);
  initTable();

</script>
</body>
</html>