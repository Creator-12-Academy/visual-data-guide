<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>DAX: ALL vs ALLEXCEPT</title>
<link rel="stylesheet" href="../../assets/style.css">
</head>
<body>

<header></header>

<div class="pageWrapper">

  <section class="card">
    <div class="lesson-header">
      <h2>üìä Sales Data</h2>
      <div id="controls-mount" class="settings-row"></div>
    </div>

    <div style="background:rgba(255,255,255,0.05); padding:0.8rem; border-radius:0.5rem; margin-bottom:1rem; border:1px solid var(--border);">
      <div style="font-size:0.75rem; color:var(--text-dim); text-transform:uppercase; margin-bottom:0.4rem; font-weight:bold;">Current Slicer Selection:</div>
      <div style="display:flex; gap:0.5rem;">
        <span style="background:rgba(14, 165, 233, 0.2); color:#38bdf8; padding:2px 8px; border-radius:4px; font-size:0.85rem; border:1px solid rgba(14, 165, 233, 0.3);">Category: Clothing</span>
        <span style="background:rgba(14, 165, 233, 0.2); color:#38bdf8; padding:2px 8px; border-radius:4px; font-size:0.85rem; border:1px solid rgba(14, 165, 233, 0.3);">Product: Jeans</span>
      </div>
    </div>

    <p style="font-size:0.9rem; color:var(--text-dim); margin-bottom: 1rem;">
      <strong>Goal:</strong> Calculate totals by ignoring specific filters.<br>
      Only "Jeans" are visible initially. Watch how the functions un-hide rows.
    </p>

    <div id="dataTable"></div>

    <div class="calculation-box" id="calcBox">
      Ready...
    </div>
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    
    <div class="control-panel">
      <div class="action-btns">
        <button class="action" id="btnAll">üåç ALL (Grand Total)</button>
        <button class="action primary" id="btnAllExcept">üéØ ALLEXCEPT (Subtotal)</button>
        <button class="action" id="btnReset">üîÑ Reset</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>üíª DAX Formula</h2>
    
    <div id="codeDisplay" class="codeArea">
      <div class="codeLine" id="line1"><span class="cmt">-- Scenario 1: Ignore ALL filters (Grand Total)</span></div>
      <div class="codeLine" id="line2"><span class="kwd">MEASURE</span> All_Sales = <span class="fn">CALCULATE</span>( <span class="fn">SUM</span>(Sales[Amt]), </div>
      <div class="codeLine" id="line3">    <span class="fn">ALL</span>( Sales ) </div>
      <div class="codeLine" id="line4">) <span class="cmt">-- Removes Category AND Product filters</span></div>
      <br>
      <div class="codeLine" id="line5"><span class="cmt">-- Scenario 2: Keep Category, Ignore Product</span></div>
      <div class="codeLine" id="line6"><span class="kwd">MEASURE</span> Cat_Subtotal = <span class="fn">CALCULATE</span>( <span class="fn">SUM</span>(Sales[Amt]),</div>
      <div class="codeLine" id="line7">    <span class="fn">ALLEXCEPT</span>( Sales, Sales[Category] )</div>
      <div class="codeLine" id="line8">) <span class="cmt">-- Keeps "Clothing", removes "Jeans"</span></div>
    </div>

    <div style="margin-top:auto; padding-top:1rem; border-top:1px solid var(--border); display:flex; align-items:center;">
      <span style="color:var(--text-dim); font-size:0.9rem;">Final Result:</span>
      <div class="total-bubble" id="totalBubble">0</div>
    </div>
  </section>

</div>

<footer></footer>

<script src="../../assets/app.js"></script>

<script>
  // --- LESSON LOGIC ---
  
  App.initLayout("ALL vs ALLEXCEPT", "../../");

  // Data: 3 items. 
  // Initial Filter: Category="Clothing" AND Product="Jeans"
  // So T-Shirt is hidden (wrong product), Laptop is hidden (wrong category).
  const data = [
    { id: 1, cat: "Clothing", prod: "T-Shirt", amt: 20 },  // Hidden by Product Filter
    { id: 2, cat: "Clothing", prod: "Jeans",   amt: 50 },  // VISIBLE
    { id: 3, cat: "Electronics", prod: "Laptop",  amt: 1000 } // Hidden by Category Filter
  ];

  const table = document.getElementById('dataTable');
  const totalBubble = document.getElementById('totalBubble');
  const lines = document.querySelectorAll('.codeLine');
  const progressFill = document.getElementById('progressFill');

  let isRunning = false;
  let shouldStop = false;

  function initTable() {
    table.innerHTML = `
      <div class="table-row header">
        <div>Category</div> <div>Product</div> <div>Amt</div> <div>Status</div>
      </div>
    `;
    data.forEach((d, i) => {
      // Logic for initial visibility
      // Filter: Cat="Clothing", Prod="Jeans"
      const isVisible = d.cat === "Clothing" && d.prod === "Jeans";
      const opacity = isVisible ? "1" : "0.2";
      const status = isVisible ? "Visible" : "Filtered";
      const statusColor = isVisible ? "var(--text-primary)" : "var(--text-dim)";

      table.innerHTML += `
        <div class="table-row" id="row-${i}" style="opacity:${opacity}; transition: opacity 0.5s;">
          <div style="font-size:0.8rem">${d.cat}</div>
          <div style="font-weight:bold;">${d.prod}</div>
          <div class="cell-num">$${d.amt}</div>
          <div class="cell-num" id="status-${i}" style="font-size:0.8rem; color:${statusColor}">${status}</div>
        </div>
      `;
    });
  }

  function reset() {
    shouldStop = true;
    window.speechSynthesis.cancel();
    if(progressFill) { progressFill.style.transition = 'none'; progressFill.style.width = '0%'; }
    
    setTimeout(() => {
      shouldStop = false; isRunning = false;
      initTable();
      App.updateText("Ready...");
      totalBubble.classList.remove('show');
      lines.forEach(l => l.classList.remove('active'));
    }, 100);
  }

  function highlight(id) {
    lines.forEach(l => l.classList.remove('active'));
    if(id) document.getElementById(id).classList.add('active');
  }

  function setRowState(index, state) {
    const row = document.getElementById(`row-${index}`);
    const status = document.getElementById(`status-${index}`);
    
    if (state === 'active') {
        row.style.opacity = "1";
        row.classList.add('row-highlight');
        status.textContent = "Included";
        status.style.color = "#4ade80";
    } else if (state === 'restore') {
        row.classList.remove('row-highlight');
        // Re-apply initial filter logic for visual reset
        const isVisible = data[index].cat === "Clothing" && data[index].prod === "Jeans";
        row.style.opacity = isVisible ? "1" : "0.2";
        status.textContent = isVisible ? "Visible" : "Filtered";
        status.style.color = isVisible ? "var(--text-primary)" : "var(--text-dim)";
    }
  }

  // --- SCENARIO 1: ALL (Grand Total) ---
  document.getElementById('btnAll').addEventListener('click', async () => {
    if(isRunning) return;
    reset();
    await new Promise(r => setTimeout(r, 200));
    if(shouldStop) return;

    isRunning = true;
    let sum = 0;

    highlight('line3');
    await App.speak("Executing ALL(Sales). This function removes ALL filters from the Sales table.");
    if(shouldStop) return;

    // Visual: Un-dim everything
    App.updateText("Removing filters on Category and Product...");
    for(let i=0; i<data.length; i++) {
        document.getElementById(`row-${i}`).style.opacity = "1";
    }
    await new Promise(r => setTimeout(r, 800));

    // Sum Loop
    highlight('line2');
    for (let i = 0; i < data.length; i++) {
      if(shouldStop) return;
      setRowState(i, 'active');
      
      sum += data[i].amt;
      App.updateText(`Row ${i+1}: Filter removed. Adding $${data[i].amt}.`);
      await App.speak(`Adding ${data[i].amt}.`);
      
      if(shouldStop) return;
      document.getElementById(`row-${i}`).classList.remove('row-highlight');
    }

    App.updateText(`Grand Total: <b>$${sum}</b>`);
    await App.speak(`Result is ${sum}. The ALL function ignored every slicer selection.`);
    
    totalBubble.textContent = `$${sum}`;
    totalBubble.classList.add('show');
    highlight(null);
    isRunning = false;
  });

  // --- SCENARIO 2: ALLEXCEPT (Subtotal) ---
  document.getElementById('btnAllExcept').addEventListener('click', async () => {
    if(isRunning) return;
    reset();
    await new Promise(r => setTimeout(r, 200));
    if(shouldStop) return;

    isRunning = true;
    let sum = 0;

    highlight('line7');
    await App.speak("Executing ALLEXCEPT. I will remove filters, EXCEPT for the Category column.");
    if(shouldStop) return;

    App.updateText("Keep 'Category: Clothing' filter. Remove 'Product: Jeans' filter.");
    
    // Logic: 
    // - Row 1 (T-Shirt, Clothing): Was hidden by "Jeans" filter. NOW VISIBLE because we removed Prod filter.
    // - Row 2 (Jeans, Clothing): Was visible. STILL VISIBLE.
    // - Row 3 (Laptop, Electronics): Was hidden by "Clothing" filter. STILL HIDDEN because we KEPT Category filter.

    // Update Opacity
    document.getElementById(`row-0`).style.opacity = "1"; // T-Shirt appears
    document.getElementById(`row-1`).style.opacity = "1"; // Jeans stays
    document.getElementById(`row-2`).style.opacity = "0.2"; // Laptop stays hidden
    
    await new Promise(r => setTimeout(r, 1000));
    if(shouldStop) return;

    // Sum Loop
    highlight('line6');
    for (let i = 0; i < data.length; i++) {
      if(shouldStop) return;
      
      // ALLEXCEPT Logic: Does it match the KEPT filter (Category=Clothing)?
      if (data[i].cat === "Clothing") {
          setRowState(i, 'active');
          sum += data[i].amt;
          App.updateText(`Row ${i+1}: Matches Category 'Clothing'. Included.`);
          await App.speak(`Category matches. Adding ${data[i].amt}.`);
      } else {
          // Skipped
          App.updateText(`Row ${i+1}: Category is 'Electronics'. Still filtered out.`);
          await App.speak(`Category does not match. Skipped.`);
      }
      
      if(shouldStop) return;
      document.getElementById(`row-${i}`).classList.remove('row-highlight');
    }

    App.updateText(`Subtotal: <b>$${sum}</b>`);
    await App.speak(`Result is ${sum}. We calculated the total for all Clothing, ignoring the Jeans selection.`);
    
    totalBubble.textContent = `$${sum}`;
    totalBubble.classList.add('show');
    highlight(null);
    isRunning = false;
  });

  document.getElementById('btnReset').addEventListener('click', reset);
  initTable();

</script>
</body>
</html>