<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>DAX: SWITCH Function</title>
<link rel="stylesheet" href="../../assets/style.css">
<style>
  /* Local Style: Highlight the active case being checked */
  .case-highlight {
    background: rgba(245, 158, 11, 0.2); /* Orange tint */
    border: 1px solid var(--accent-m);
    border-radius: 4px;
    padding: 2px 4px;
    transition: all 0.2s;
  }
</style>
</head>
<body>

<header></header>

<div class="pageWrapper">

  <section class="card">
    <div class="lesson-header">
      <h2>ðŸ“Š Priority Codes</h2>
      <div id="controls-mount" class="settings-row"></div>
    </div>

    <p style="font-size:0.9rem; color:var(--text-dim); margin-bottom: 1rem;">
      <strong>Goal:</strong> Map numeric codes to text labels.<br>
      <strong>SWITCH</strong> moves line-by-line until it finds a match.
    </p>

    <div id="dataTable"></div>

    <div class="calculation-box" id="calcBox">
      Ready...
    </div>
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    
    <div class="control-panel">
      <div class="action-btns">
        <button class="action" id="btnExact">ðŸŽ¯ Exact Match</button>
        <button class="action primary" id="btnTrue">âœ… SWITCH(TRUE)</button>
        <button class="action" id="btnReset">ðŸ”„ Reset</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>ðŸ’» DAX Formula</h2>
    
    <div id="codeDisplay" class="codeArea">
      <div class="codeLine" id="line1"><span class="cmt">-- Scenario 1: Exact Value Match</span></div>
      <div class="codeLine" id="line2"><span class="kwd">MEASURE</span> Label = <span class="fn">SWITCH</span>( Priority[Code], </div>
      <div class="codeLine" id="line3">    <span class="val">1</span>, <span class="str">"High"</span>,    <span class="cmt">-- Case 1</span></div>
      <div class="codeLine" id="line4">    <span class="val">2</span>, <span class="str">"Medium"</span>,  <span class="cmt">-- Case 2</span></div>
      <div class="codeLine" id="line5">    <span class="val">3</span>, <span class="str">"Low"</span>,     <span class="cmt">-- Case 3</span></div>
      <div class="codeLine" id="line6">    <span class="str">"Unknown"</span>        <span class="cmt">-- Else</span></div>
      <div class="codeLine" id="line7">)</div>
      <br>
      <div class="codeLine" id="line8"><span class="cmt">-- Scenario 2: SWITCH TRUE (Advanced Logic)</span></div>
      <div class="codeLine" id="line9"><span class="fn">SWITCH</span>( <span class="kwd">TRUE</span>(), </div>
      <div class="codeLine" id="line10">    [Code] = 1, <span class="str">"Critical"</span>,</div>
      <div class="codeLine" id="line11">    [Code] <= 3, <span class="str">"Normal"</span>,</div>
      <div class="codeLine" id="line12">    <span class="str">"Review"</span> )</div>
    </div>

    <div style="margin-top:auto; padding-top:1rem; border-top:1px solid var(--border); display:flex; align-items:center;">
      <span style="color:var(--text-dim); font-size:0.9rem;">Result:</span>
      <div class="total-bubble" id="totalBubble">-</div>
    </div>
  </section>

</div>

<footer></footer>

<script src="../../assets/app.js"></script>

<script>
  // --- LESSON LOGIC ---
  App.initLayout("SWITCH Function", "../../");

  const data = [
    { code: 1 },
    { code: 2 },
    { code: 5 } // Unknown case
  ];

  const table = document.getElementById('dataTable');
  const totalBubble = document.getElementById('totalBubble');
  const lines = document.querySelectorAll('.codeLine');
  const progressFill = document.getElementById('progressFill');

  let isRunning = false;
  let shouldStop = false;

  function initTable() {
    table.innerHTML = `
      <div class="table-row header"><div>ID</div> <div>Code</div> <div>Label</div></div>
    `;
    data.forEach((d, i) => {
      table.innerHTML += `
        <div class="table-row" id="row-${i}">
          <div>${i+101}</div>
          <div class="cell-num">${d.code}</div>
          <div class="cell-num" id="res-${i}" style="color:var(--text-dim)">-</div>
        </div>
      `;
    });
  }

  function reset() {
    shouldStop = true;
    window.speechSynthesis.cancel();
    if(progressFill) { progressFill.style.transition = 'none'; progressFill.style.width = '0%'; }
    
    setTimeout(() => {
      shouldStop = false; isRunning = false;
      initTable();
      App.updateText("Ready...");
      totalBubble.classList.remove('show');
      lines.forEach(l => l.classList.remove('active'));
    }, 100);
  }

  function highlight(id) {
    lines.forEach(l => l.classList.remove('active'));
    if(id) document.getElementById(id).classList.add('active');
  }

  // --- SCENARIO 1: EXACT MATCH ---
  document.getElementById('btnExact').addEventListener('click', async () => {
    if(isRunning) return;
    reset();
    await new Promise(r => setTimeout(r, 200));
    if(shouldStop) return;

    isRunning = true;
    highlight('line2');
    await App.speak("Starting SWITCH. I check the 'Code' column and try to match it against my list of cases.");

    for (let i = 0; i < data.length; i++) {
      if(shouldStop) return;
      const row = document.getElementById(`row-${i}`);
      const resCell = document.getElementById(`res-${i}`);
      row.classList.add('row-highlight');

      const val = data[i].code;
      App.updateText(`Checking Code: ${val}`);
      await App.speak(`Code is ${val}. Checking cases.`);

      if (val === 1) {
        highlight('line3');
        App.updateText(`Matched Case 1 -> "High"`);
        await App.speak("Matches 1. Result is High.");
        resCell.textContent = "High";
        resCell.style.color = "#ef4444"; // Red
      } 
      else if (val === 2) {
        highlight('line3');
        await new Promise(r => setTimeout(r, 300)); // Visual delay skipping 1
        highlight('line4');
        App.updateText(`Matched Case 2 -> "Medium"`);
        await App.speak("Matches 2. Result is Medium.");
        resCell.textContent = "Medium";
        resCell.style.color = "#facc15"; // Yellow
      } 
      else if (val === 3) {
        highlight('line5');
        resCell.textContent = "Low";
      } 
      else {
        // Fallback
        highlight('line3'); await new Promise(r => setTimeout(r, 200));
        highlight('line4'); await new Promise(r => setTimeout(r, 200));
        highlight('line5'); await new Promise(r => setTimeout(r, 200));
        highlight('line6');
        App.updateText(`No match found. Using Else -> "Unknown"`);
        await App.speak("No match found. Using default result.");
        resCell.textContent = "Unknown";
        resCell.style.color = "var(--text-dim)";
      }

      totalBubble.textContent = resCell.textContent;
      totalBubble.classList.add('show');
      
      if(shouldStop) return;
      await new Promise(r => setTimeout(r, 500));
      row.classList.remove('row-highlight');
      totalBubble.classList.remove('show');
    }

    App.updateText("Done.");
    highlight(null);
    isRunning = false;
  });

  // --- SCENARIO 2: SWITCH TRUE ---
  document.getElementById('btnTrue').addEventListener('click', async () => {
    if(isRunning) return;
    reset();
    await new Promise(r => setTimeout(r, 200));
    if(shouldStop) return;

    isRunning = true;
    highlight('line9');
    await App.speak("SWITCH TRUE. This is powerful. I evaluate conditions one by one. The first one that is TRUE wins.");

    for (let i = 0; i < data.length; i++) {
      if(shouldStop) return;
      const row = document.getElementById(`row-${i}`);
      const resCell = document.getElementById(`res-${i}`);
      row.classList.add('row-highlight');

      const val = data[i].code;
      
      // Check 1
      highlight('line10');
      if (val === 1) {
        App.updateText(`${val} equals 1? TRUE.`);
        await App.speak(`Code is 1. That is Critical.`);
        resCell.textContent = "Critical";
        resCell.style.color = "#ef4444";
      } 
      else {
        // Check 2
        App.updateText(`${val} equals 1? FALSE. Next...`);
        await new Promise(r => setTimeout(r, 300));
        
        highlight('line11');
        if (val <= 3) {
            App.updateText(`${val} <= 3? TRUE.`);
            await App.speak(`Code is ${val}. That is less than 3. Result Normal.`);
            resCell.textContent = "Normal";
            resCell.style.color = "#4ade80";
        } else {
            // Check 3 (Else)
            App.updateText(`${val} <= 3? FALSE. Next...`);
            await new Promise(r => setTimeout(r, 300));
            highlight('line12');
            await App.speak("No conditions met. Needs Review.");
            resCell.textContent = "Review";
            resCell.style.color = "var(--text-dim)";
        }
      }

      totalBubble.textContent = resCell.textContent;
      totalBubble.classList.add('show');
      
      if(shouldStop) return;
      await new Promise(r => setTimeout(r, 500));
      row.classList.remove('row-highlight');
      totalBubble.classList.remove('show');
    }

    App.updateText("Done.");
    highlight(null);
    isRunning = false;
  });

  document.getElementById('btnReset').addEventListener('click', reset);
  initTable();

</script>
</body>
</html>